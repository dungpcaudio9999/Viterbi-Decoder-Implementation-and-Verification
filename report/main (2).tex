\documentclass[12pt,a4paper]{report}

% ================= CẤU HÌNH GÓI LỆNH =================
\usepackage{fontspec}
\usepackage{polyglossia}
\setdefaultlanguage{vietnamese}
\setmainfont{Liberation Serif}

\usepackage{amsmath, amsfonts, amssymb} % Gói toán học
\usepackage{graphicx}   % Chèn ảnh
\graphicspath{{images/}} % Đường dẫn tới thư mục chứa ảnh
\usepackage{float}      % Định vị ảnh [H]
\usepackage{tabularx}   % Bảng biểu
\usepackage{longtable}  % Bảng dài qua trang
\usepackage{geometry}   % Căn lề
\usepackage{setspace}   % Giãn dòng
\usepackage{indentfirst}% Thụt đầu dòng đoạn đầu tiên
\usepackage{titlesec}   % Định dạng tiêu đề
\usepackage{hyperref}   % Tạo link mục lục
\usepackage{caption}    % Chú thích bảng/hình
% \usepackage{minted}     % (Tùy chọn) Chèn code đẹp, nhưng cần cài python-pygments. Dùng verbatim cho đơn giản.
\usepackage{listings}   % Chèn code

% Cấu hình hiển thị code
\lstset{
    basicstyle=\small\ttfamily,
    breaklines=true,
    frame=single,
    numbers=left,
    numberstyle=\tiny,
    tabsize=2,
    captionpos=b
}

% Cấu hình lề trang
\geometry{left=3cm, right=2cm, top=2.5cm, bottom=2.5cm}

% Cấu hình Header/Footer
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{BTL Thiết kế VLSI}
\fancyhead[R]{Viterbi Decoder SoC}
\fancyfoot[C]{\thepage}

% Cấu hình tiêu đề chương
\titleformat{\chapter}[block]{\bfseries\Large}{\chaptertitlename\ \thechapter:}{0.5em}{}
\titlespacing*{\chapter}{0pt}{-20pt}{20pt}

% Cấu hình Hyperlink
\hypersetup{colorlinks=true, linkcolor=black, filecolor=magenta, urlcolor=blue}

\onehalfspacing % Giãn dòng 1.5

\begin{document}

% ====================================================================
% TRANG BÌA
% ====================================================================
\begin{titlepage}
    \begin{center}
        \textbf{\large ĐẠI HỌC BÁCH KHOA HÀ NỘI}\\
        \textbf{\large TRƯỜNG ĐIỆN – ĐIỆN TỬ}
        
        \vspace{1cm}
        \includegraphics[width=3cm]{hust_logo.png} 
        \vspace{1cm}
        
        {\bfseries \Huge BÀI TẬP LỚN \par}
        {\bfseries \Huge THIẾT KẾ VLSI \par}
        
        \vspace{1.5cm}
        
        {\bfseries \Large Đề tài: \\ THIẾT KẾ VÀ TỔNG HỢP HỆ THỐNG VITERBI DECODER \\ TỪ RTL ĐẾN GDSII SỬ DỤNG OPENLANE FLOW \par}
        
        \vspace{2cm}
        
        \begin{tabular}{ll}
            \textbf{Giảng viên hướng dẫn:} & TS. Nguyễn Vũ Thắng \\
            \textbf{Sinh viên thực hiện:}  & Phạm Chí Dũng – 20200106 \\
                                           & Võ Ngọc Vinh – 20227447 \\
                                           & Nguyễn Văn Dương – 20241713E \\
            \textbf{Lớp:}                  & 163187 – ET4340
        \end{tabular}
        
        \vfill
        \textbf{Hà Nội, 2026}
    \end{center}
\end{titlepage}

% ====================================================================
% TÓM TẮT
% ====================================================================
\chapter*{TÓM TẮT NỘI DUNG}
\addcontentsline{toc}{chapter}{TÓM TẮT NỘI DUNG}

Báo cáo này trình bày quy trình toàn diện về thiết kế, kiểm chứng và thực thi vật lý cho một hệ thống giải mã Viterbi (Viterbi Decoder SoC). Hệ thống được xây dựng hoàn chỉnh với các khối giao tiếp ngoại vi (FIFO, PISO, SIPO) để xử lý dữ liệu dòng. Điểm nổi bật của thiết kế là việc áp dụng kiến trúc \textbf{Register Exchange (RE)} trong đơn vị truy vết, giúp tối ưu hóa băng thông xử lý và giảm độ trễ so với phương pháp Traceback truyền thống.

Kết quả kiểm tra chức năng (Functional Verification) cho thấy mạch hoạt động chính xác tuyệt đối với bộ dữ liệu kiểm thử. Quy trình thiết kế vật lý (Physical Design) được thực hiện bằng công cụ mã nguồn mở \textbf{OpenLane Flow} với công nghệ Sky130, đạt kết quả khả quan về diện tích ($0.16 mm^2$), công suất tiêu thụ thấp và đáp ứng tốt các yêu cầu về thời gian (Timing) ở tần số 50MHz.

\newpage
\tableofcontents
\newpage

\listoffigures
\listoftables
\newpage

% ====================================================================
% CHƯƠNG 1
% ====================================================================
\chapter{TỔNG QUAN VỀ MÃ TÍCH CHẬP VÀ GIẢI MÃ VITERBI}

\section{Giới thiệu mã tích chập}
Mã tích chập (Convolutional Codes) là một lớp mã sửa lỗi quan trọng, trong đó luồng bit đầu ra được tạo ra từ việc thực hiện phép tích chập giữa luồng bit đầu vào với đáp ứng xung của các thanh ghi dịch. Một bộ mã hóa tích chập được đặc trưng bởi bộ tham số $(n, k, m)$, trong đó:
\begin{itemize}
    \item $k$: Số bit đầu vào tại mỗi nhịp thời gian.
    \item $n$: Số bit đầu ra tại mỗi nhịp thời gian.
    \item $m$: Độ sâu của bộ nhớ (số lượng thanh ghi dịch).
\end{itemize}
Độ dài giới hạn quan trọng $K = m + 1$ biểu thị số lượng bit đầu vào ảnh hưởng đến một bit đầu ra. Tỷ lệ mã $R = k/n$ biểu thị hiệu suất băng thông.

\section{Nguyên lý giải mã Viterbi}
Giải mã Viterbi là một giải thuật quy hoạch động dùng để tìm đường dẫn có khả năng xảy ra cao nhất (Maximum Likelihood Path) trên biểu đồ lưới (Trellis diagram). Quá trình giải mã gồm ba bước cơ bản:
\begin{enumerate}
    \item \textbf{Branch Metric Calculation}: Tính toán độ tương đồng giữa tín hiệu nhận được và tín hiệu lý thuyết trên mỗi nhánh.
    \item \textbf{Path Metric Update (ACS)}: Tại mỗi trạng thái, cộng Metric nhánh vào Metric đường dẫn tích lũy, so sánh và chọn đường dẫn tốt nhất (Survivor Path).
    \item \textbf{Survivor Path Memory}: Lưu trữ lịch sử quyết định để khôi phục lại chuỗi dữ liệu gốc.
\end{enumerate}

% ====================================================================
% CHƯƠNG 2
% ====================================================================
\chapter{ĐẶC TẢ KỸ THUẬT VÀ THIẾT KẾ RTL}

\section{Đặc tả kỹ thuật (Specifications)}
Dựa trên yêu cầu của đề tài, hệ thống Viterbi Decoder được thiết kế với các thông số kỹ thuật sau:

\begin{table}[H]
    \centering
    \caption{Các thông số thiết kế chính}
    \begin{tabular}{|l|l|}
    \hline
    \textbf{Tham số} & \textbf{Giá trị} \\ \hline
    Constraint Length ($K$) & 3 \\ \hline
    Code Rate ($R$) & 1/2 \\ \hline
    Generators (Octal) & $G_1 = 7_8 (111_2)$, $G_2 = 5_8 (101_2)$ \\ \hline
    Traceback Length ($L$) & 15 \\ \hline
    Architecture Type & Register Exchange (RE) \\ \hline
    Soft/Hard Decision & Hard Decision (1-bit quantization) \\ \hline
    \end{tabular}
\end{table}

Bảng tín hiệu giao tiếp của khối Top-Level (\texttt{system\_top}):

\begin{table}[H]
    \centering
    \caption{Đặc tả giao diện System Top}
    \begin{tabularx}{\textwidth}{|l|l|l|X|}
    \hline
    \textbf{Port Name} & \textbf{Width} & \textbf{Dir} & \textbf{Description} \\ \hline
    \texttt{clk} & 1 & Input & System Clock (Positve Edge) \\ \hline
    \texttt{rst\_n} & 1 & Input & System Reset (Active Low) \\ \hline
    \texttt{dvalid\_i} & 1 & Input & Valid signal for input data (FIFO Write Enable) \\ \hline
    \texttt{data\_i} & 16 & Input & Input Data Word (16-bit) \\ \hline
    \texttt{data\_o} & 8 & Output & Decoded Data Byte (8-bit) \\ \hline
    \texttt{valid\_o} & 1 & Output & Valid signal for output data \\ \hline
    \texttt{busy\_o} & 1 & Output & Busy Flag (Indicates FIFO Full) \\ \hline
    \end{tabularx}
\end{table}

\section{Kiến trúc hệ thống (System Architecture)}
Để đảm bảo khả năng tích hợp thực tế, hệ thống được thiết kế dạng SoC thu nhỏ với luồng dữ liệu Pipeline:

\begin{figure}[H]
    \centering
    % Placeholder cho sơ đồ khối, bạn có thể thêm ảnh system_block.png sau
    % \includegraphics[width=0.9\textwidth]{system_block.png}
    \caption{Sơ đồ khối hệ thống System Top}
\end{figure}

Luồng dữ liệu di chuyển như sau:
\begin{enumerate}
    \item \textbf{Input}: Dữ liệu 16-bit được nạp vào \texttt{Sync FIFO}.
    \item \textbf{FIFO}: Đệm dữ liệu để tách biệt miền tần số/tốc độ của nguồn phát và bộ giải mã.
    \item \textbf{PISO}: Lấy 16-bit từ FIFO, tách thành từng cặp 2-bit (Symbol) truyền cho Core.
    \item \textbf{Viterbi Core}: Thực hiện giải mã và trả về từng bit kết quả (1-bit).
    \item \textbf{SIPO}: Gom 8 bit kết quả thành 1 Byte và đẩy ra \texttt{data\_o}.
\end{enumerate}

\section{Triển khai RTL (RTL Implementation)}
Mã nguồn RTL được viết bằng Verilog HDL, tuân thủ các quy tắc thiết kế đồng bộ.

\subsection{Khối tính toán nhánh (BMU)}
BMU (\texttt{bmu.v}) nhận cặp bit đầu vào và tính khoảng cách Hamming cho 8 trường hợp chuyển đổi của 4 trạng thái. Logic thực hiện hoàn toàn tổ hợp.

\subsection{Khối Cộng-So sánh-Chọn (ACSU)}
ACSU (\texttt{acsu.v}) là trái tim của bộ giải mã. Tại mỗi chu kỳ xung nhịp, nó thực hiện:
\begin{itemize}
    \item Cộng Metric nhánh vào Path Metric cũ.
    \item So sánh hai đường dẫn đến cùng một trạng thái.
    \item Chọn đường dẫn bé hơn và lưu lại bit quyết định (0 hoặc 1).
\end{itemize}

\subsection{Khối truy vết Survivor Memory (TBU)}
Thay vì sử dụng bộ nhớ RAM để lưu vết và quay lui (Traceback) gây độ trễ lớn, nhóm sử dụng kỹ thuật \textbf{Register Exchange (RE)}. 

Mỗi trạng thái ($S_0, S_1, S_2, S_3$) quản lý một thanh ghi dịch lịch sử dài 15 bit.
\begin{lstlisting}[language=Verilog, caption=Cơ chế Register Exchange trong TBU]
// Ví dụ logic cập nhật cho trạng thái S0
if (dec_bits_i[0] == 0) 
    history_s0 <= {history_s0[TBL-2:0], 1'b0}; // Chọn đường từ S0 cũ
else                    
    history_s0 <= {history_s1[TBL-2:0], 1'b0}; // Chọn đường từ S1 cũ
\end{lstlisting}

Nhờ cơ chế này, sau khi pipeline được điền đầy (15 chu kỳ), đầu ra dữ liệu là liên tục (streaming) với năng suất (throughput) cao nhất (1 bit/cycle).

% ====================================================================
% CHƯƠNG 3
% ====================================================================
\chapter{KIỂM TRA CHỨC NĂNG MẠCH}

\section{Môi trường kiểm chứng (Testbench Environment)}
Môi trường kiểm tra được xây dựng trong file \texttt{tb\_system\_top.sv} với các thành phần:
\begin{itemize}
    \item \textbf{Generator}: Tạo ngẫu nhiên 1025 gói dữ liệu 16-bit.
    \item \textbf{Driver}: Đưa dữ liệu vào hệ thống qua giao thức bắt tay (valid/busy).
    \item \textbf{Monitor}: Thu thập dữ liệu đầu ra \texttt{data\_o}.
    \item \textbf{Scoreboard}: So sánh kết quả mô phỏng với "Golden Model" (mô hình chuẩn).
\end{itemize}

\section{Kết quả mô phỏng (Simulation Results)}
Dưới đây là kết quả mô phỏng chi tiết cho từng khối chức năng (Unit Level) và toàn hệ thống (System Level). Các hình ảnh bao gồm log dữ liệu và giản đồ sóng xác nhận hoạt động chính xác của thiết kế.

% --- FIFO ---
\subsection{Khối đệm dữ liệu (FIFO)}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{fifo_log_part1.png}
    \caption{Log mô phỏng FIFO - Phần 1}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{fifo_log_part2.png}
    \caption{Log mô phỏng FIFO - Phần 2}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=1.0\textwidth]{fifo_wave.png}
    \caption{Giản đồ sóng tín hiệu FIFO}
\end{figure}

% --- PISO ---
\subsection{Khối chuyển đổi song song sang nối tiếp (PISO)}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{piso_log_part1.png}
    \caption{Log mô phỏng PISO - Phần 1}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{piso_log_part2.png}
    \caption{Log mô phỏng PISO - Phần 2}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=1.0\textwidth]{piso_wave.png}
    \caption{Giản đồ sóng tín hiệu PISO}
\end{figure}

% --- BMU ---
\subsection{Khối tính toán nhánh (BMU)}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{bmu_log_part1.png}
    \caption{Log mô phỏng BMU - Phần 1}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{bmu_log_part2.png}
    \caption{Log mô phỏng BMU - Phần 2}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=1.0\textwidth]{bmu_wave.png}
    \caption{Giản đồ sóng tín hiệu BMU}
\end{figure}

% --- ACSU ---
\subsection{Khối Cộng - So sánh - Chọn (ACSU)}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{acsu_log_part1.png}
    \caption{Log mô phỏng ACSU - Phần 1}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{acsu_log_part2.png}
    \caption{Log mô phỏng ACSU - Phần 2}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=1.0\textwidth]{acsu_wave.png}
    \caption{Giản đồ sóng tín hiệu ACSU}
\end{figure}

% --- PMU ---
\subsection{Khối quản lý Metric (PMU)}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{pmu_log_part1.png}
    \caption{Log mô phỏng PMU - Phần 1}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{pmu_log_part2.png}
    \caption{Log mô phỏng PMU - Phần 2}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=1.0\textwidth]{pmu_wave.png}
    \caption{Giản đồ sóng tín hiệu PMU}
\end{figure}

% --- TBU ---
\subsection{Khối truy vết (TBU)}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{tbu_log_part1.png}
    \caption{Log mô phỏng TBU - Phần 1}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{tbu_log_part2.png}
    \caption{Log mô phỏng TBU - Phần 2}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=1.0\textwidth]{tbu_wave.png}
    \caption{Giản đồ sóng tín hiệu TBU}
\end{figure}

% --- SIPO ---
\subsection{Khối chuyển đổi nối tiếp sang song song (SIPO)}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{sipo_log_part1.png}
    \caption{Log mô phỏng SIPO - Phần 1}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{sipo_log_part2.png}
    \caption{Log mô phỏng SIPO - Phần 2}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=1.0\textwidth]{sipo_wave.png}
    \caption{Giản đồ sóng tín hiệu SIPO}
\end{figure}

% ====================================================================
% CHƯƠNG 4
% ====================================================================
\chapter{TỔNG HỢP VÀ THIẾT KẾ VẬT LÝ}

\section{Quy trình OpenLane Flow}
Thiết kế được đưa vào quy trình OpenLane để chuyển đổi từ RTL sang GDSII. Các bước thực hiện bao gồm:
\begin{enumerate}
    \item \textbf{Synthesis (Yosys)}: Tổng hợp logic và map vào thư viện cells Sky130.
    \item \textbf{Floorplan}: Định nghĩa kích thước die, tạo lưới nguồn (PDN).
    \item \textbf{Placement (OpenROAD)}: Đặt các cell vào khung layout, tối ưu hóa độ dài dây dẫn.
    \item \textbf{CTS}: Cân bằng cây xung clock để giảm Clock Skew.
    \item \textbf{Routing}: Đi dây chi tiết và kiểm tra luật thiết kế (DRC).
\end{enumerate}

\section{Kết quả tổng hợp (Synthesis Results)}
Báo cáo tổng hợp cho thấy tài nguyên phần cứng sử dụng rất hiệu quả:

\begin{table}[H]
    \centering
    \caption{Tài nguyên phần cứng sau tổng hợp}
    \begin{tabular}{|l|l|}
    \hline
    \textbf{Tài nguyên} & \textbf{Số lượng} \\ \hline
    Số lượng cổng logic (Combinational) & $\approx$ 1400 \\ \hline
    Số lượng Flip-Flops (Sequential) & $\approx$ 600 \\ \hline
    Tổng số Cells & 2032 \\ \hline
    Fanout tối đa & 10 \\ \hline
    \end{tabular}
\end{table}

\section{Kết quả thiết kế vật lý (Physical Layout)}
Sau khi hoàn tất Routing và Sign-off, các thông số vật lý cuối cùng ghi nhận được từ file \texttt{metrics.csv}:

\begin{itemize}
    \item \textbf{Diện tích (Die Area)}: $0.16 mm^2$.
    \item \textbf{Mật độ (Core Utilization)}: 40\% (Đảm bảo không gian cho routing và tránh tắc nghẽn).
    \item \textbf{Công suất tiêu thụ ước tính}: $0.007 mW$ (Tại điều kiện hoạt động điển hình).
    \item \textbf{Thời gian (Timing)}: 
        \begin{itemize}
            \item Worst Negative Slack (WNS): 4.15 ns.
            \item Tần số hoạt động tối đa: 50 MHz.
        \end{itemize}
    \item \textbf{Kiểm tra vật lý}: Không có vi phạm LVS (Layout Vs Schematic) và DRC (Design Rule Check).
\end{itemize}

\begin{figure}[H]
    \centering
    % Placeholder cho layout
    % \includegraphics[width=0.8\textwidth]{layout_gds.png}
    \caption{Hình ảnh Layout GDSII cuối cùng của hệ thống}
\end{figure}

% ====================================================================
% KẾT LUẬN
% ====================================================================
\chapter*{KẾT LUẬN}
\addcontentsline{toc}{chapter}{KẾT LUẬN}

Đồ án đã thiết kế và hiện thực hóa thành công một hệ thống Viterbi Decoder SoC từ mức ý tưởng đến Layout vật lý. Việc áp dụng thành công kỹ thuật \textbf{Register Exchange} đã chứng minh hiệu quả vượt trội trong việc xử lý dòng bit liên tục. Quy trình thiết kế sử dụng hoàn toàn các công cụ nguồn mở (OpenLane, Sky130, iVerilog) mở ra hướng đi khả thi và tiết kiệm chi phí cho việc thiết kế và sản xuất chip VLSI tại Việt Nam.

\newpage
\begin{thebibliography}{9}
\bibitem{viterbi} A. J. Viterbi, "Error bounds for convolutional codes and an asymptotically optimum decoding algorithm," IEEE Transactions on Information Theory.
\bibitem{openlane} OpenLane Documentation, "The Open-Source Digital ASIC Implementation Flow".
\bibitem{sky130} SkyWater SKY130 PDK, Google Open Source Silicon.
\end{thebibliography}

\end{document}